import{onCleanup as w}from"solid-js";import*as r from"d3";const M=n=>{const c=window.innerWidth*.8,i=window.innerHeight*.8,d=t=>{t.children?t.children.forEach(d):t.importance=n.adjacencyData[t.name]?Object.values(n.adjacencyData[t.name]).reduce((l,y)=>l+y,0):0};d(n.data);const e=r.hierarchy(n.data).sum(t=>t.lines??0),a=e.links(),s=e.descendants(),f=r.forceSimulation(s).force("link",r.forceLink(a).id(t=>t.index??0).distance(0).strength(.5)).force("charge",r.forceManyBody().strength(t=>3*-Math.min(s[t.index].data.lines??100,500))).force("x",r.forceX()).force("y",r.forceY()),o=r.create("svg").attr("width",c).attr("height",i).attr("viewBox",[-c/2,-i/2,c,i]).attr("style","max-width: 100%; height: auto;"),u=Object.entries(n.adjacencyData).flatMap(([t,l])=>Object.entries(l).map(([y,j])=>({source:s.find(g=>g.data.name===t),target:s.find(g=>g.data.name===y),value:j}))).filter(t=>t.source&&t.target),m=o.append("g").attr("stroke","#17a").selectAll("line").data(u).join("line").attr("stroke-width",t=>Math.sqrt(t.value)).attr("stroke-opacity",t=>t.value/50).attr("x1",t=>t.source.x).attr("y1",t=>t.source.y).attr("x2",t=>t.target.x).attr("y2",t=>t.target.y),p=o.append("g").attr("stroke","#000").attr("stroke-opacity",1).attr("stroke-width",1.5).selectAll("line").data(a).join("line"),h=o.append("g").attr("fill","#fff").attr("stroke","#000").attr("stroke-width",1.5).selectAll("circle").data(s).join("circle").attr("fill",t=>t.children?null:"#000").attr("stroke",t=>t.children?null:"#fff").attr("r",t=>t.children?.length?10:Math.sqrt(t.data.importance+2)).call(v(f));h.append("title").text(t=>t.data.name);const k=o.append("g").style("font","10px sans-serif").attr("pointer-events","none").attr("selectable","false").attr("text-anchor","begin").selectAll("text").data(e.descendants()).join("text").style("fill-opacity",t=>t.children?.length?1:t.data.importance/10).text(t=>t.data.name);f.on("tick",()=>{p.attr("x1",t=>t.source.x).attr("y1",t=>t.source.y).attr("x2",t=>t.target.x).attr("y2",t=>t.target.y),m.attr("x1",t=>t.source.x).attr("y1",t=>t.source.y).attr("x2",t=>t.target.x).attr("y2",t=>t.target.y),h.attr("cx",t=>t.x).attr("cy",t=>t.y),k.attr("x",t=>t.x).attr("y",t=>t.y)}),f.on("end",()=>{console.log("Simulation ended")});const x=r.zoom().scaleExtent([.5,32]).on("zoom",t=>{const{transform:l}=t;o.attr("transform",l)});return o.call(x).call(x.transform,r.zoomIdentity),w(()=>f.stop()),o.node()},v=n=>{function c(e,a){e.active||n.alphaTarget(.2).restart(),a.fx=a.x,a.fy=a.y}function i(e,a){a.fx=e.x,a.fy=e.y}function d(e,a){e.active||n.alphaTarget(0),a.fx=null,a.fy=null}return r.drag().on("start",c).on("drag",i).on("end",d)};export{M as default};
